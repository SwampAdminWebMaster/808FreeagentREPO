<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>808 Mafia OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic body styling */
        body {
            font-family: 'monospace', sans-serif; /* Monospace font for the OS feel */
            overflow: hidden; /* Prevent scrollbars on the main body */
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            background-color: black; /* Ensure body background is black */
        }

        /* Custom animation for pulsing modal border */
        @keyframes pulse-themed-border {
          0% { box-shadow: 0 0 3px 1px rgba(255, 0, 0, 0.6), 0 0 6px 3px rgba(236, 72, 153, 0.5), 0 0 9px 5px rgba(168, 85, 247, 0.4), 0 0 1px 1px rgba(192, 192, 192, 0.7); }
          50% { box-shadow: 0 0 6px 2px rgba(255, 0, 0, 0.4), 0 0 12px 6px rgba(236, 72, 153, 0.3), 0 0 18px 10px rgba(168, 85, 247, 0.2), 0 0 2px 2px rgba(220, 220, 220, 0.5); }
          100% { box-shadow: 0 0 3px 1px rgba(255, 0, 0, 0.6), 0 0 6px 3px rgba(236, 72, 153, 0.5), 0 0 9px 5px rgba(168, 85, 247, 0.4), 0 0 1px 1px rgba(192, 192, 192, 0.7); }
        }
        .animate-themed-pulse-border {
          animation: pulse-themed-border 2.5s infinite ease-in-out;
          border: 1px solid rgba(220, 220, 220, 0.6); /* Base border */
        }

        /* Ensure modals and overlays have correct stacking order */
        .modal-container { z-index: 50; } /* Individual modal window */
        .modal-overlay { z-index: 40; } /* Dimmed background for standard modals */
        .confirmation-modal-overlay { z-index: 60; } /* Shutdown confirmation */
        .hidden-log-overlay { z-index: 55; } /* Boot log overlay */
        .shutdown-overlay { z-index: 100; } /* Final shutdown screen */
        #matrix-canvas { z-index: 0; } /* Matrix background behind everything */
        #app-root { z-index: 10; } /* Main UI container above matrix */

        /* Basic icon replacement styling */
        .icon-placeholder {
            display: inline-block;
            width: 1em;
            height: 1em;
            line-height: 1em;
            text-align: center;
            font-size: inherit; /* Match surrounding text size */
            margin-right: 0.25em; /* Spacing */
            vertical-align: middle; /* Align icons better with text */
        }

        /* Hide scrollbar for modal content but allow scrolling */
        .modal-content-area::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .modal-content-area {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
            overflow-y: auto;
            /* Ensure iframe content can be seen */
            display: flex; /* Use flex to make iframe fit */
            flex-direction: column; /* Stack iframe and potential attribution */
        }
        .modal-content-area > iframe {
            flex-shrink: 0; /* Prevent iframe from shrinking */
            min-height: 450px; /* Ensure iframe has minimum height */
        }
        /* Style for the SoundCloud attribution div */
         .soundcloud-attribution {
            font-size: 10px;
            color: #cccccc;
            line-break: anywhere;
            word-break: normal;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            font-family: Interstate, Lucida Grande, Lucida Sans Unicode, Lucida Sans, Garuda, Verdana, Tahoma, sans-serif;
            font-weight: 100;
            padding: 5px;
            background-color: black; /* Match modal background */
            flex-shrink: 0; /* Prevent shrinking */
        }
        .soundcloud-attribution a {
            color: #cccccc;
            text-decoration: none;
        }


        /* Line clamp for desktop icon labels */
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }

        /* Ensure alert boxes are styled somewhat thematically */
        /* Note: Styling native alert() is very limited */
        /* This is more a placeholder for potential future custom alert implementation */
        .custom-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #ffcc00;
            padding: 15px;
            border: 1px solid #ffcc00;
            border-radius: 5px;
            z-index: 200;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

    </style>
</head>
<body class="bg-black text-red-500">

    <div id="app-root"></div>

    <canvas id="matrix-canvas" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>

    <script>
        // --- Configuration ---
        const MATRIX_CHARS = "80";
        const MATRIX_FONT_SIZE = 14;
        const MATRIX_SPEED = 90; // Milliseconds between matrix updates
        const MATRIX_FADE_FACTOR = 0.15; // Controls how quickly the trail fades (0-1)
        const MATRIX_COLOR = 'rgba(255, 0, 0, 0.5)'; // Red color for matrix characters
        const AGENT_ID_LENGTH = 8; // Length of the generated Agent ID
        const ICON_SIZE_CLASS = 'w-20 h-20'; // Tailwind class for desktop icon size
        const NOTE_EMAIL_TARGET = "808MAFIALIVE@GMAIL.COM"; // Simulated target email
        const PADDING = 16; // General padding from screen edges in pixels

        // Permission Denied Message (Used for locked features)
        const PERMISSION_DENIED_MESSAGE = "Access Denied: Your Free Agent ID does not grant the required permissions for this feature, or access has been administratively locked. Please contact your Network Administrator for permission reevaluation.";

        // Boot Messages displayed during startup
        const VERBOSE_BOOT_MESSAGES = [
            "Initializing 808 Core Systems...",
            "Loading Bass Kernels v1.1 [OK]",
            "Mounting Filesystem /dev/snd01...",
            "Checking Drum Machine Integrity...",
            "Syncing MIDI Clock [OK]",
            "Loading Sequencer Modules...",
            "Applying Matrix Filters v2.2...",
            "Loading Event Data Files...",
            "Initializing Desktop Environment...",
            "Boot Sequence Complete. Welcome to 808 Mafia OS.",
        ];

        // Shutdown Messages displayed during shutdown
        const SHUTDOWN_MESSAGES = [
            "Broadcasting shutdown signal...",
            "Stopping services: midi_sync, sequencer_daemon, matrix_filter...",
            "Unmounting filesystems...",
            "/dev/snd01 unmounted.",
            "/ unmounted.",
            "System will power off now.",
            "Redirecting to 808mafia.live...",
        ];
        const SHUTDOWN_DELAY = 300; // Milliseconds between shutdown messages

        // Data for documents inside the 'Event Docs' folder
        const eventDocuments = [
            { id: 'event_overview', label: 'Event_Overview.txt', icon: '📄', type: 'file', content: `**808 MAFIA EVENTS - Sluggfest / Dripfest Overview 2025**\n\nSuper producer conference and Ultra music festival hosted performance series.\n\n**Schedule:**\n* Pre-party and talent briefing: TBA\n* Admin meeting: TBA\n* March 28th: 1st Annual Launch Party (Theme: Drip Fest)\n* October 31st, November 1st, 2nd: DRIP FEST / $LUGGFEST (Main Event)\n * Hours: October 31st, 8:08 AM - 2:08 AM\n* November 8th: Arigato Staff After Party\n * Location: Tokyo Japan, Kill Bill Hotel\n` },
            { id: 'mission_statement', label: 'Mission_Statement.txt', icon: '📄', type: 'file', content: `**Mission & Significance**\n\nTo give back to the live art, music, dance, flow arts, and fashion communities on a local level, while providing local talent exposure to the world's best global artists and producers. This event will be held annually and grow to become a nationwide global talent search with multiple tours and events year-round.\n\n**Significance:** To inform and gather all forms of artist and producer talents along with enthusiasts and fans worldwide for an annual conference on Halloween. To show respect for the dead in a non-traditional gathering celebrating life and death respectfully, with no bias to specific religious or belief systems.` },
            { id: 'event_details', label: 'Event_Details.txt', icon: '📄', type: 'file', content: `**Event Details (Main Event: Oct 31 - Nov 2)**\n\n* **Venue:** HardRock / Fairgrounds / Amphitheater (Specific location TBD)\n* **Theme:** Anti Hero/Hero SciFi Space Adventure, 90s Beach Vibes, Cosplay Ball Pool Party (with sci-fi alien planet beach resort themes). Aligning with the 808 Mafia brand for growth and expansion.\n* **Target Audience:** Fans aged 18-28. Also includes major and local studios, music artists, dance/live performers, fashion designers/brands.\n* **Duration:** 3-day total major event dates with free agent early bird access. (2-13 HR work days for crew/performers).\n\n**Event Program & Features:**\n* **Headliners:** 8 headliners each day.\n* **Conference Elements:** Super producer conference & artist showcase, Clinics & master classes, 808 MAFIA producer ONEonONE Q&A and group meet & greets.\n* **Performances & Activities:** Silks and Aerial performers, Fire Flow performers, Twerk team performance/battles/awards, 8 Battle Octagon rings (808 shape) for local artists/DJs/dancers/rap battles, Model runway & fashion show.\n* **Interactive Experiences:** Live streams, VR classes, VR adventure streaming interactive augmented reality experience.\n* **Parties:** Free Agent Blok Party Pool Parties (all hotels, 24/7), Secret speakeasy-style performance (password required).\n* **Media:** Behind-the-scenes documentary, Promotional media (before/after), Interviews (crew/talent).\n` },
            { id: 'marketing_promo', label: 'Marketing_Promo.txt', icon: '📄', type: 'file', content: `**Marketing and Promotion**\n\n* **Strategies:** Create buzz and generate attendance via social media campaigns, collaborations, influencer outreach, traditional marketing.\n* **Platforms:** Facebook, Instagram, Soundcloud (social media hype campaigns).\n* **Materials:** Online Flyers, ads, Soundcloud sponsorship, QR codes, VR promotion events/classes/master classes (with interactive AR layer at events), Press kits (sent to local news media).\n* **Teams:** Street teams, local I.A.T.S.E UNION crews, Local Volunteers.\n` },
            { id: 'contact_info', label: 'Contact_Info.txt', icon: '📄', type: 'file', content: `**808 MAFIA EVENTS - Contact & Leadership**\n\n**Primary Contact:**\n* Name: StikiDaSwampGod\n* Phone: 808.850.3519\n* Email: Stk808info@gmail.com\n\n**Leadership:**\n* CEO: STiKi-DaSwampGod\n* CEO: $LUGG\n\n**Secondary Contact Listing:**\n* Cell: (970)-638-3084\n* Email: Stk808info@gmail.com\n` }
        ];

        // Data defining the items appearing on the desktop
        const desktopItemsData = [
            { id: 'soundcloud_player', label: 'MediaPlayer.app', icon: '▶️', type: 'app' },
            { id: 'youtube_player', label: 'VideoPlayer.app', icon: '🎬', type: 'app' },
            { id: 'documents_folder', label: 'Event Docs', icon: '📁', type: 'folder', content: 'Contains event planning documents.' },
            { id: 'link_808mafia_io', label: '808MAFIA.IO', icon: '🌐', url: 'https://808mafia.io', type: 'link' },
            { id: 'link_808mafia_live', label: '808MAFIA.LIVE', icon: '🌐', url: 'https://808mafia.live', type: 'link' },
            { id: 'link_eventbrite', label: 'Tickets', icon: '🎟️', url: 'https://www.eventbrite.com/e/808-mafia-drippfest-digital-vr-access-pass-tickets-1265666916819', type: 'link' },
            { id: 'network', label: 'Network', icon: '📶', type: 'system' },
            { id: 'trash', label: 'Trash', icon: '🗑️', type: 'system' },
        ].map(item => ({ ...item, isVisible: true })); // Add isVisible property, default to true

        // --- Global State Variables ---
        let appState = 'booting'; // Current state: booting, login, desktop, shutdown-confirm, shutting-down
        let credentials = { email: null, agentId: null }; // Stores user credentials after login
        let isStartMenuOpen = false; // Tracks if the start menu is open
        let currentModal = { isOpen: false, title: '', content: '', type: 'file', id: null }; // State for the currently open standard modal
        let isNoteModalOpen = false; // Tracks if the 'New Note' modal is open
        let showHiddenLog = false; // Tracks if the verbose boot log is visible
        let isDragging = false; // Flag indicating if a modal is currently being dragged
        let dragOffset = { x: 0, y: 0 }; // Offset between mouse pointer and modal top-left corner during drag
        let draggedModal = null; // Reference to the DOM element of the modal being dragged

        // --- DOM Element References ---
        const appRoot = document.getElementById('app-root'); // Main container for UI elements
        const matrixCanvas = document.getElementById('matrix-canvas'); // Canvas for background effect
        const matrixCtx = matrixCanvas.getContext('2d'); // 2D rendering context for the canvas

        // --- Helper Functions ---

        /**
         * Generates a random numeric string of a specified length.
         * @param {number} length - The desired length of the Agent ID.
         * @returns {string} The generated numeric Agent ID.
         */
        const generateAgentId = (length) => {
            let result = '';
            const characters = '0123456789';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        };

        /**
         * Basic parser to convert simple markdown-like syntax to HTML.
         * Handles **bold** and * list items.
         * @param {string} content - The text content to parse.
         * @returns {string} HTML representation of the content.
         */
        const parseContent = (content) => {
            if (typeof content !== 'string') return '';
            return content.split('\n').map(line => {
                line = line.trim();
                // Convert **bold** text
                if (line.startsWith('**') && line.endsWith('**')) {
                    return `<strong class="block mb-1 text-red-400 font-bold text-base">${line.substring(2, line.length - 2)}</strong>`;
                }
                // Convert * list items
                if (line.startsWith('* ')) {
                    return `<li class="ml-5 list-disc text-gray-300">${line.substring(2)}</li>`;
                }
                // Wrap other lines in paragraphs or use <br> for empty lines
                return line ? `<p class="mb-2 text-gray-300">${line}</p>` : '<br>';
            }).join('');
        };

        // --- Matrix Background Logic ---
        let matrixAnimationFrameId; // ID for the animation frame request
        let matrixDrops = []; // Array to store the y-position of each column's drop
        let matrixResizeTimeout; // Timeout ID for debouncing resize events
        let matrixLastTimestamp = 0; // Timestamp of the last matrix draw call

        /**
         * Sets up the matrix canvas dimensions and initializes drop positions.
         */
        const setupMatrix = () => {
            if (!matrixCanvas) return;
            matrixCanvas.width = window.innerWidth;
            matrixCanvas.height = window.innerHeight;
            // Calculate the number of columns based on canvas width and font size
            const newColumns = Math.max(1, Math.floor(matrixCanvas.width / MATRIX_FONT_SIZE));
            // Initialize or resize the drops array, setting initial y-position to 1
            matrixDrops = Array(newColumns).fill(1);
        };

        /**
         * Handles window resize events, debouncing the setupMatrix call.
         */
        const handleMatrixResize = () => {
            clearTimeout(matrixResizeTimeout);
            matrixResizeTimeout = setTimeout(setupMatrix, 250); // Wait 250ms after resize stops
        };

        /**
         * Draws a single frame of the Matrix animation.
         */
        const drawMatrix = () => {
            if (!matrixCtx || !matrixCanvas) return;
            // Draw a semi-transparent black rectangle to create the fading trail effect
            matrixCtx.fillStyle = `rgba(0, 0, 0, ${MATRIX_FADE_FACTOR})`;
            matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);

            // Set color and font for the falling characters
            matrixCtx.fillStyle = MATRIX_COLOR;
            matrixCtx.font = `${MATRIX_FONT_SIZE}px monospace`;

            // Iterate over each column
            matrixDrops.forEach((y, i) => {
                // Pick a random character from MATRIX_CHARS
                const text = MATRIX_CHARS.charAt(Math.floor(Math.random() * MATRIX_CHARS.length));
                // Calculate the x-coordinate for the current column
                const x = i * MATRIX_FONT_SIZE;
                // Draw the character at its current position
                matrixCtx.fillText(text, x, y * MATRIX_FONT_SIZE);

                // Reset the drop to the top if it goes off-screen and random chance met
                if (y * MATRIX_FONT_SIZE > matrixCanvas.height && Math.random() > 0.975) {
                    matrixDrops[i] = 0;
                }
                // Increment the y-position for the next frame (or stay at 0 based on chance)
                 if(matrixDrops[i] > 0 || Math.random() > 0.1) {
                    matrixDrops[i]++;
                 }
            });
        };

        /**
         * The main animation loop for the Matrix effect.
         * @param {number} timestamp - The current time provided by requestAnimationFrame.
         */
        const animateMatrix = (timestamp) => {
            const deltaTime = timestamp - matrixLastTimestamp;
            // Throttle drawing to control speed
            if (deltaTime > MATRIX_SPEED) {
                drawMatrix();
                matrixLastTimestamp = timestamp;
            }
            // Request the next frame
            matrixAnimationFrameId = requestAnimationFrame(animateMatrix);
        };

        /**
         * Initializes and starts the Matrix background animation.
         */
        const startMatrix = () => {
            setupMatrix();
            animateMatrix(0); // Start the animation loop
            window.addEventListener('resize', handleMatrixResize); // Listen for resize events
        };

        /**
         * Stops the Matrix background animation and cleans up listeners.
         */
        const stopMatrix = () => {
             cancelAnimationFrame(matrixAnimationFrameId); // Stop the animation loop
             window.removeEventListener('resize', handleMatrixResize); // Remove resize listener
             clearTimeout(matrixResizeTimeout); // Clear any pending resize timeout
        };

        // --- Modal Dragging Logic ---

        /**
         * Handles the mousedown event on a modal header to initiate dragging.
         * @param {MouseEvent} e - The mousedown event object.
         * @param {HTMLElement} modalElement - The modal element being dragged.
         */
        const handleModalMouseDown = (e, modalElement) => {
            const header = modalElement.querySelector('.modal-header');
            // Only drag if clicking on the header itself, not buttons inside it
            if (header && header.contains(e.target) && !e.target.closest('button')) {
                isDragging = true;
                draggedModal = modalElement;
                const modalRect = modalElement.getBoundingClientRect();
                // Calculate the offset from the mouse click to the modal's top-left corner
                dragOffset = {
                    x: e.clientX - modalRect.left,
                    y: e.clientY - modalRect.top
                };
                // Change cursor style to indicate dragging
                modalElement.classList.add('cursor-grabbing');
                header.classList.add('cursor-grabbing');
                header.classList.remove('cursor-grab');
                e.preventDefault(); // Prevent text selection during drag
            }
        };

        /**
         * Handles the global mousemove event to update the position of the dragged modal.
         * @param {MouseEvent} e - The mousemove event object.
         */
        const handleGlobalMouseMove = (e) => {
            if (!isDragging || !draggedModal) return; // Only run if dragging is active

            const modalWidth = draggedModal.offsetWidth;
            const modalHeight = draggedModal.offsetHeight;

            // Calculate the new top-left position based on mouse movement and initial offset
            let newX = e.clientX - dragOffset.x;
            let newY = e.clientY - dragOffset.y;

            // Constrain the modal position within the viewport boundaries
            newX = Math.min(Math.max(0, newX), window.innerWidth - modalWidth);
            newY = Math.min(Math.max(0, newY), window.innerHeight - modalHeight);

            // Apply the new position using CSS transform
            draggedModal.style.transform = `translate(${newX}px, ${newY}px)`;
        };

        /**
         * Handles the global mouseup event to stop dragging.
         */
        const handleGlobalMouseUp = () => {
            if (isDragging && draggedModal) {
                 // Reset cursor style
                 draggedModal.classList.remove('cursor-grabbing');
                 const header = draggedModal.querySelector('.modal-header');
                 if (header) {
                     header.classList.remove('cursor-grabbing');
                     header.classList.add('cursor-grab');
                 }
            }
            // Reset dragging state
            isDragging = false;
            draggedModal = null;
        };

        // Add global listeners for mouse move and mouse up to handle dragging anywhere on the screen
        document.addEventListener('mousemove', handleGlobalMouseMove);
        document.addEventListener('mouseup', handleGlobalMouseUp);


        // --- UI Rendering Functions ---

        /**
         * Renders the initial boot screen with a progress bar.
         */
        const renderBootScreen = () => {
            // Set the HTML content for the boot screen
            appRoot.innerHTML = `
                <div class="fixed inset-0 flex flex-col items-center justify-center bg-black text-red-500 font-mono z-[100]">
                    <div class="z-10 text-center p-8 bg-black bg-opacity-80 rounded-lg border border-red-800 shadow-lg shadow-red-900/50">
                        <h1 class="text-4xl font-bold mb-6 animate-pulse">808MAFIALIVE</h1>
                        <div class="w-64 h-4 bg-gray-800 border border-red-700 rounded-full overflow-hidden mb-2">
                            <div id="boot-progress-bar" class="h-full bg-gradient-to-r from-pink-600 to-red-600 transition-all duration-100 ease-linear" style="width: 0%;"></div>
                        </div>
                        <p id="boot-progress-text" class="text-lg">Loading... 0%</p>
                        <div class="text-xs text-gray-600 mt-4">(Press Esc later to view boot log)</div>
                    </div>
                </div>
            `;

            // Initialize progress simulation variables
            let progress = 0;
            const targetProgress = 808; // Target percentage for effect
            const duration = 5000; // Total duration of the boot animation in ms
            const intervalTime = duration / targetProgress; // Time per percentage point increase
            const progressBar = document.getElementById('boot-progress-bar');
            const progressText = document.getElementById('boot-progress-text');

            // Start the interval to update the progress bar
            const interval = setInterval(() => {
                progress++;
                // Calculate the visual progress percentage (capped at 100)
                const normalizedProgress = Math.min(100, (progress / targetProgress) * 100);
                // Update the progress bar width and text
                if (progressBar) progressBar.style.width = `${normalizedProgress}%`;
                if (progressText) progressText.textContent = `Loading... ${progress}%`;

                // When the target progress is reached
                if (progress >= targetProgress) {
                    clearInterval(interval); // Stop the interval
                    // Wait a bit, then transition to the login state
                    setTimeout(() => {
                        appState = 'login';
                        render(); // Re-render the UI for the login screen
                    }, 500);
                }
            }, intervalTime);
        };

        /**
         * Renders the login screen form.
         */
        const renderLoginScreen = () => {
            // Set the HTML content for the login screen
            appRoot.innerHTML = `
                <div class="fixed inset-0 flex items-center justify-center bg-black text-red-500 font-mono p-4 z-10">
                    <form id="login-form" class="z-10 w-full max-w-md bg-black bg-opacity-80 p-8 rounded-lg border border-red-800 shadow-lg shadow-red-900/50">
                        <h1 class="text-2xl font-bold text-center mb-6 text-red-400">808 Mafia OS Login</h1>
                        <div class="mb-4">
                            <label for="email" class="block text-sm font-medium mb-1 text-red-300">Operator Email:</label>
                            <input type="email" id="email" placeholder="your-email@example.com" required
                                   class="w-full px-3 py-2 bg-gray-900 border border-red-700 rounded-md text-red-300 placeholder-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition duration-200">
                        </div>
                        <div class="mb-6 flex items-end gap-4">
                            <button type="button" id="generate-id-button"
                                    class="px-4 py-2 rounded-md text-sm font-medium transition duration-200 flex items-center justify-center bg-purple-700 hover:bg-purple-600 text-white disabled:bg-gray-700 disabled:text-gray-400 disabled:cursor-not-allowed">
                                <span class="icon-placeholder">🛡️</span> Generate Agent ID
                            </button>
                            <div id="agent-id-display-container" class="flex-grow hidden">
                                <label for="agentIdDisplay" class="block text-sm font-medium mb-1 text-red-300">Your Agent ID:</label>
                                <input type="text" id="agentIdDisplay" readonly
                                       class="w-full px-3 py-2 bg-gray-800 border border-purple-700 rounded-md text-pink-300 focus:outline-none cursor-default">
                            </div>
                        </div>
                         <div id="login-error" class="text-sm text-yellow-400 mb-4 hidden"></div>
                        <button type="submit" id="login-button" disabled
                                class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-200 flex items-center justify-center gap-2 disabled:bg-gray-700 disabled:text-gray-400 disabled:cursor-not-allowed">
                           <span class="icon-placeholder">🔑</span> Login
                        </button>
                        <div class="mt-6 text-center text-xs text-gray-500">Need access? Contact administration.</div>
                    </form>
                </div>
            `;

            // Get references to form elements
            const loginForm = document.getElementById('login-form');
            const emailInput = document.getElementById('email');
            const generateButton = document.getElementById('generate-id-button');
            const agentIdContainer = document.getElementById('agent-id-display-container');
            const agentIdInput = document.getElementById('agentIdDisplay');
            const loginButton = document.getElementById('login-button');
            const errorDiv = document.getElementById('login-error');
            let currentAgentId = ''; // Store the generated ID locally
            let isGenerating = false; // Prevent multiple generation clicks

            // Function to enable/disable the login button based on state
            const updateLoginButtonState = () => {
                loginButton.disabled = !currentAgentId || !emailInput.value.trim();
            };

            // Handle email input changes
            emailInput.addEventListener('input', () => {
                currentAgentId = ''; // Reset agent ID if email changes
                agentIdContainer.classList.add('hidden'); // Hide the ID display
                agentIdInput.value = '';
                errorDiv.classList.add('hidden'); // Hide any previous errors
                errorDiv.textContent = '';
                // Enable generate button only if email is present and not currently generating
                generateButton.disabled = !emailInput.value.trim() || isGenerating;
                updateLoginButtonState(); // Update login button state
            });

            // Handle click on the "Generate Agent ID" button
            generateButton.addEventListener('click', () => {
                const email = emailInput.value.trim();
                // Basic email validation
                if (!email || !/\S+@\S+\.\S+/.test(email)) {
                    errorDiv.textContent = 'Please enter a valid email address.';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                errorDiv.classList.add('hidden'); // Hide error message
                isGenerating = true;
                generateButton.disabled = true;
                generateButton.innerHTML = `<span class="icon-placeholder animate-spin">🔄</span> Generating...`; // Show loading state

                // Simulate generation delay
                setTimeout(() => {
                    currentAgentId = generateAgentId(AGENT_ID_LENGTH); // Generate the ID
                    agentIdInput.value = currentAgentId; // Display the ID
                    agentIdContainer.classList.remove('hidden'); // Show the ID container
                    console.log(`User Logged: Email=${email}, AgentID=${currentAgentId}`); // Log credentials (simulation)
                    isGenerating = false; // Reset generating state
                    generateButton.disabled = false; // Re-enable button
                     generateButton.innerHTML = `<span class="icon-placeholder">🛡️</span> Generate Agent ID`; // Restore button text
                    updateLoginButtonState(); // Update login button state
                }, 500); // 500ms delay
            });

            // Handle form submission
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault(); // Prevent default form submission
                // Check if email and agent ID are present
                if (currentAgentId && emailInput.value.trim()) {
                    // Store credentials in global state
                    credentials.email = emailInput.value.trim();
                    credentials.agentId = currentAgentId;
                    appState = 'desktop'; // Change app state to desktop
                    console.log("Login Successful.");
                    render(); // Re-render the UI for the desktop
                } else {
                    // Show error if conditions not met
                    errorDiv.textContent = 'Please enter your email and generate an Agent ID first.';
                    errorDiv.classList.remove('hidden');
                }
            });

             // Initial state checks on load
             generateButton.disabled = !emailInput.value.trim();
             updateLoginButtonState();
        };

        /**
         * Renders the main desktop interface (icons, taskbar).
         */
        const renderDesktop = () => {
            // Set the HTML structure for the desktop
            appRoot.innerHTML = `
                <div id="desktop-container" class="relative flex flex-col h-screen bg-black text-red-600 font-mono overflow-hidden">
                    <main id="desktop-main" class="flex-1 relative z-10 overflow-hidden p-4 pt-6">
                        </main>

                    <footer class="relative h-12 bg-black bg-opacity-90 border-t border-purple-800/50 flex items-center justify-between px-4 z-20 flex-shrink-0">
                        <div class="w-1/3 flex justify-start">
                            <button id="new-note-button" class="flex items-center gap-1 px-2 py-1 rounded-md text-xs bg-green-800 hover:bg-green-700 text-green-300 transition duration-150 focus:outline-none focus:ring-1 focus:ring-green-500" title="Create New Note">
                                <span class="icon-placeholder">➕</span> New Note
                            </button>
                        </div>
                        <div id="start-menu-container" class="relative flex justify-center w-1/3">
                            <button id="start-button" class="flex items-center gap-2 px-4 py-1.5 rounded-md transition duration-150 font-bold text-sm hover:bg-pink-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2 focus:ring-offset-black bg-purple-900 text-pink-300">
                                <span class="icon-placeholder">⚡</span> 808 Mafia OS
                            </button>
                            <div id="start-menu" class="hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-1 w-64 bg-black bg-opacity-95 border border-pink-700 rounded-lg shadow-xl shadow-pink-900/50 z-50 text-red-300 font-mono overflow-hidden flex flex-col max-h-[70vh]">
                                <div class="flex-grow overflow-y-auto p-1">
                                     </div>
                                <div class="p-2 border-t border-purple-800/50 mt-auto flex-shrink-0 bg-black">
                                    <ul class="space-y-1">
                                        <li>
                                            <button id="restart-button" class="w-full text-left flex items-center gap-3 px-3 py-1.5 rounded-md hover:bg-yellow-600 hover:text-black transition duration-150 text-sm text-yellow-300">
                                                 <span class="icon-placeholder">🔄</span> Restart Session
                                            </button>
                                        </li>
                                        <li>
                                            <button id="shutdown-button" class="w-full text-left flex items-center gap-3 px-3 py-1.5 rounded-md hover:bg-red-600 hover:text-white transition duration-150 text-sm text-red-400">
                                                 <span class="icon-placeholder">🔌</span> Shutdown
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-end w-1/3">
                            <div id="clock-display" class="flex items-center gap-2 text-xs text-pink-300 px-2">
                                <span class="icon-placeholder">⏰</span>
                                <span id="clock-date"></span>
                                <span id="clock-time"></span>
                            </div>
                            <div class="ml-2 text-xs text-gray-400 hidden lg:block truncate px-2 border-l border-gray-700" title="Agent ID: ${credentials.agentId} | Email: ${credentials.email}">
                                Agent: ${credentials.agentId}
                            </div>
                        </div>
                    </footer>

                     <div id="modal-area"></div>
                     <div id="hidden-log-area"></div>
                </div>
            `;

            // Render the dynamic parts of the desktop
            renderDesktopIcons();
            renderStartMenuItems();
            updateClock(); // Initial clock update
            setInterval(updateClock, 1000); // Update clock every second

            // --- Get references to taskbar buttons ---
            const startButton = document.getElementById('start-button');
            const startMenu = document.getElementById('start-menu');
            const newNoteButton = document.getElementById('new-note-button');
            const restartButton = document.getElementById('restart-button');
            const shutdownButton = document.getElementById('shutdown-button');


            // --- Add Event Listeners for Desktop Elements ---

            // Toggle Start Menu visibility on button click
            startButton.addEventListener('click', (e) => {
                 e.stopPropagation(); // Prevent click from closing menu immediately
                 isStartMenuOpen = !isStartMenuOpen;
                 startMenu.classList.toggle('hidden', !isStartMenuOpen);
                 // Update button style based on menu state
                 startButton.classList.toggle('bg-pink-800', isStartMenuOpen);
                 startButton.classList.toggle('text-white', isStartMenuOpen);
                 startButton.classList.toggle('bg-purple-900', !isStartMenuOpen);
                 startButton.classList.toggle('text-pink-300', !isStartMenuOpen);
            });

             // Close Start Menu if clicking outside of it
             document.addEventListener('click', (e) => {
                 const startMenuContainer = document.getElementById('start-menu-container');
                  // Check if menu is open and the click was outside the menu container
                  if (isStartMenuOpen && !startMenuContainer.contains(e.target)) {
                      closeStartMenu(); // Use the helper function to close
                  }
             });

             // Open 'New Note' modal on button click
             newNoteButton.addEventListener('click', () => {
                 openNoteModal();
                 closeStartMenu(); // Close start menu if it was open
             });

             // Handle Restart button click
             restartButton.addEventListener('click', () => {
                 handleRestart();
                 closeStartMenu();
             });

             // Handle Shutdown button click
             shutdownButton.addEventListener('click', () => {
                  handleInitiateShutdown();
                  closeStartMenu();
             });
        };

        /**
         * Helper function to close the start menu and reset button styles.
         */
        const closeStartMenu = () => {
            const startMenu = document.getElementById('start-menu');
            const startButton = document.getElementById('start-button');
            if (isStartMenuOpen && startMenu && startButton) {
                isStartMenuOpen = false;
                startMenu.classList.add('hidden'); // Hide the menu
                // Reset button styles
                startButton.classList.remove('bg-pink-800', 'text-white');
                startButton.classList.add('bg-purple-900', 'text-pink-300');
            }
        };

        /**
         * Renders the icons onto the desktop area based on desktopItemsData.
         */
        const renderDesktopIcons = () => {
            const desktopMain = document.getElementById('desktop-main');
            if (!desktopMain) return;
            desktopMain.innerHTML = ''; // Clear any existing icons first

            // Iterate through the desktop items data
            desktopItemsData.forEach(item => {
                if (!item.isVisible) return; // Skip if item is marked as not visible

                // Create the main div for the icon
                const iconDiv = document.createElement('div');
                iconDiv.id = `icon-${item.id}`;
                // Apply base classes, hover effects, and the configured size class
                iconDiv.className = `absolute flex flex-col items-center justify-start space-y-1 p-1 rounded-lg hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-pink-500 transition-colors duration-150 text-center cursor-pointer ${ICON_SIZE_CLASS}`;
                iconDiv.title = item.label; // Set tooltip

                // Determine icon color based on item type
                let iconColorClass = 'text-red-400'; // Default color
                if (item.type === 'link') {
                    iconColorClass = item.id === 'link_eventbrite' ? 'text-orange-400' : 'text-blue-400';
                } else if (item.type === 'app') {
                    iconColorClass = item.id === 'youtube_player' ? 'text-red-400' : 'text-pink-400';
                } else if (item.type === 'folder') {
                    iconColorClass = 'text-yellow-500';
                } else if (item.type === 'system') {
                    iconColorClass = 'text-gray-400';
                }

                // Set the inner HTML for the icon and label
                iconDiv.innerHTML = `
                    <span class="text-3xl ${iconColorClass} mb-0.5 flex-shrink-0 pointer-events-none">${item.icon || '?'}</span>
                    <span class="text-xs text-gray-200 break-words line-clamp-2 leading-tight pointer-events-none select-none">${item.label}</span>
                `;

                // Calculate and apply the position style
                const style = getIconStyle(item, desktopMain);
                Object.assign(iconDiv.style, style);


                // Add click listener to handle opening/activating the item
                iconDiv.addEventListener('click', () => handleDesktopItemClick(item));

                // Append the icon to the desktop area
                desktopMain.appendChild(iconDiv);
            });
        };

        /**
         * Calculates the CSS position styles (top, left, right, bottom) for a desktop icon.
         * @param {object} item - The desktop item data object.
         * @param {HTMLElement} desktopElement - The main desktop container element.
         * @returns {object} A style object with positioning properties.
         */
        const getIconStyle = (item, desktopElement) => {
            // Get dimensions for calculation (fallback to window dimensions)
            const desktopHeight = desktopElement?.clientHeight || window.innerHeight;
            const desktopWidth = desktopElement?.clientWidth || window.innerWidth;
            const taskbarHeight = 48; // Height of the taskbar in pixels
            const iconWidth = 80; // Corresponds to w-20 Tailwind class
            const iconHeight = 80; // Corresponds to h-20 Tailwind class
            const linkIconSpacing = 90; // Horizontal spacing between link icons

            // Determine position based on item ID
            switch (item.id) {
                case 'network': return { top: `${PADDING}px`, right: `${PADDING}px` };
                case 'trash': return { bottom: `${PADDING + taskbarHeight}px`, right: `${PADDING}px` }; // Position above taskbar
                case 'soundcloud_player': return { left: `calc(50% - ${iconWidth / 2}px - 50px)`, top: `calc(50% - ${iconHeight / 2}px)` }; // Center left
                case 'youtube_player': return { left: `calc(50% - ${iconWidth / 2}px + 50px)`, top: `calc(50% - ${iconHeight / 2}px)` }; // Center right
                case 'documents_folder': return { left: `${PADDING}px`, top: `${PADDING}px` }; // Top left
                // Special positioning for link icons at the bottom center
                case 'link_808mafia_io':
                case 'link_808mafia_live':
                case 'link_eventbrite':
                    const links = desktopItemsData.filter(i => i.type === 'link');
                    const linkIndex = links.findIndex(l => l.id === item.id);
                    if (linkIndex === -1) return { display: 'none' }; // Hide if not found (shouldn't happen)
                    const totalLinkWidth = links.length * linkIconSpacing; // Total width occupied by links
                    const startLinkX = (desktopWidth - totalLinkWidth) / 2; // Starting X for the first link
                    return { left: `${startLinkX + linkIndex * linkIconSpacing}px`, bottom: `${taskbarHeight + PADDING}px` }; // Position above taskbar
                default: return { top: `${PADDING * 5}px`, left: `${PADDING}px` }; // Fallback position
            }
        };

        /**
         * Handles clicks on desktop icons, triggering appropriate actions.
         * @param {object} item - The data object for the clicked desktop item.
         */
         const handleDesktopItemClick = (item) => {
             if (item.type === 'folder') {
                 // Open folder modal
                 openModal(item.label, item.content, 'folder', item.id);
             } else if (item.type === 'app') {
                 // Open app modal (content handled by renderModalContent)
                 openModal(item.label, '', 'app', item.id);
             } else if (item.type === 'system') {
                  if (item.id === 'trash') {
                      // Show permission error for trash
                      alert(PERMISSION_DENIED_MESSAGE);
                  } else if (item.id === 'network') {
                       // Open network modal (button inside is locked)
                       openModal(item.label, 'Network Settings', 'system', item.id);
                  } else {
                       // Deny other system items
                       alert(PERMISSION_DENIED_MESSAGE);
                  }
             } else if (item.url) {
                 // Open external links in a new tab
                 window.open(item.url, '_blank', 'noopener,noreferrer');
             }
             closeStartMenu(); // Close start menu after action
         };

        /**
         * Renders the items inside the Start Menu.
         */
        const renderStartMenuItems = () => {
            // Get the container div inside the start menu
            const menuContentDiv = document.querySelector('#start-menu > div:first-child');
            if (!menuContentDiv) return;

            menuContentDiv.innerHTML = ''; // Clear existing items

            // Filter desktop items by type for menu sections
            const apps = desktopItemsData.filter(item => item.type === 'app' && item.isVisible);
            const folders = desktopItemsData.filter(item => item.type === 'folder' && item.isVisible);
            const webLinks = desktopItemsData.filter(item => item.type === 'link' && item.isVisible);
            // Include Trash in system items for the menu, even though clicking it shows an error
            const systemItems = desktopItemsData.filter(item => item.type === 'system' && item.isVisible);

            /**
             * Helper function to create a section in the start menu.
             * @param {string} title - The title of the section.
             * @param {string} icon - The emoji icon for the section title.
             * @param {Array} items - Array of item objects for this section.
             * @param {string} itemColorClass - Tailwind color class for item icons.
             * @param {string} titleColorClass - Tailwind color class for the section title.
             * @returns {string} HTML string for the menu section.
             */
            const createSection = (title, icon, items, itemColorClass, titleColorClass) => {
                 if (items.length === 0) return ''; // Don't render empty sections
                 // Add border-top if this is not the first section
                 const borderClass = menuContentDiv.children.length > 0 ? 'border-t border-purple-800/50' : '';
                 return `
                    <div class="px-2 pt-2 pb-1 ${borderClass}">
                        <h3 class="font-bold ${titleColorClass} flex items-center gap-2"><span class="icon-placeholder">${icon}</span> ${title}</h3>
                    </div>
                    <ul class="px-1 space-y-1">
                        ${items.map(item => `
                            <li>
                                <button data-item-id="${item.id}" class="start-menu-item w-full text-left flex items-center gap-3 px-3 py-1.5 rounded-md hover:bg-pink-700 hover:text-white transition duration-150 text-sm">
                                    <span class="icon-placeholder ${itemColorClass}">${item.icon}</span>
                                    <span>${item.label}</span>
                                </button>
                            </li>
                        `).join('')}
                    </ul>
                 `;
            };

            // Render each section
             menuContentDiv.innerHTML += createSection('Applications', '▶️', apps, 'text-pink-400', 'text-pink-400');
             menuContentDiv.innerHTML += createSection('Folders', '📁', folders, 'text-yellow-500', 'text-yellow-500');
             menuContentDiv.innerHTML += createSection('Websites & Links', '🌐', webLinks, 'text-blue-400', 'text-blue-400');
             menuContentDiv.innerHTML += createSection('System', '⚙️', systemItems, 'text-gray-400', 'text-gray-400');


             // Add event listeners to the newly created menu item buttons
             menuContentDiv.querySelectorAll('.start-menu-item').forEach(button => {
                 button.addEventListener('click', () => {
                     const itemId = button.getAttribute('data-item-id');
                     // Find the corresponding item data
                     const item = desktopItemsData.find(d => d.id === itemId) || eventDocuments.find(d => d.id === itemId);
                     if (item) {
                         handleDesktopItemClick(item); // Use the same handler as desktop icons
                     }
                 });
                 // Special case: Apply orange color to Eventbrite ticket icon
                 if (button.getAttribute('data-item-id') === 'link_eventbrite') {
                     const iconSpan = button.querySelector('.icon-placeholder');
                     if (iconSpan) iconSpan.classList.replace('text-blue-400', 'text-orange-400');
                 }
             });
        };

        /**
         * Updates the date and time display in the taskbar.
         */
        const updateClock = () => {
            const clockDateEl = document.getElementById('clock-date');
            const clockTimeEl = document.getElementById('clock-time');
            if (!clockDateEl || !clockTimeEl) return; // Exit if elements not found

            const now = new Date();
            // Formatting options for date and time
            const optionsDate = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            const optionsTime = { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true };

            // Update the text content
            clockDateEl.textContent = now.toLocaleDateString(undefined, optionsDate);
            clockTimeEl.textContent = now.toLocaleTimeString(undefined, optionsTime);
        };


        // --- Modal Logic ---

        /**
         * Opens a standard modal window with the given properties.
         * @param {string} title - The title for the modal header.
         * @param {string} content - The content to display (can be HTML or parsed markdown).
         * @param {string} [type='file'] - The type of modal ('file', 'folder', 'app', 'system').
         * @param {string|null} [id=null] - The unique ID of the item opening the modal.
         */
        const openModal = (title, content, type = 'file', id = null) => {
            currentModal = { isOpen: true, title, content, type, id }; // Update global modal state
            renderModal(); // Render the modal UI
            closeStartMenu(); // Ensure start menu is closed
        };

        /**
         * Closes the currently open standard modal.
         */
        const closeModal = () => {
            currentModal = { isOpen: false, title: '', content: '', type: 'file', id: null }; // Reset modal state
            renderModal(); // Re-render (which will remove the modal elements)
        };

        /**
         * Opens the dedicated 'New Note' modal.
         */
         const openNoteModal = () => {
             isNoteModalOpen = true; // Set note modal state
             renderNoteModal(); // Render the note modal UI
             closeStartMenu(); // Ensure start menu is closed
         };

         /**
          * Closes the 'New Note' modal.
          */
         const closeNoteModal = () => {
             isNoteModalOpen = false; // Reset note modal state
             renderNoteModal(); // Re-render (which will remove the modal elements)
         };

        /**
         * Handles opening a file item from within a folder modal.
         * @param {object} file - The data object for the file to open.
         */
        const openFileFromFolder = (file) => {
            // Close the parent folder modal first
            if (currentModal.type === 'folder') {
                closeModal();
            }
            // Open the file modal
            openModal(file.label, file.content, 'file', file.id);
        };

        /**
         * Simulates sending the content of the 'New Note' modal.
         * @param {string} title - The title entered in the note modal.
         * @param {string} content - The content entered in the note modal.
         * @returns {boolean} True if the note was "sent" (validation passed), false otherwise.
         */
         const handleSendNote = (title, content) => {
             // Basic validation
             if (!title.trim() || !content.trim()) {
                 alert("Please enter both a title and content for the note.");
                 return false; // Indicate failure
             }
             // Log the simulated action to the console
             console.log(`--- New Note ---\nTo: ${NOTE_EMAIL_TARGET}\nSubject: 808 OS Note - ${title}\n---\n${content}\n--- End Note (Simulation) ---`);
             // Show a confirmation alert
             alert(`Note "${title}" sent to ${NOTE_EMAIL_TARGET} (simulation).`);
             return true; // Indicate success
         };

         /**
          * Handles clicks on the "Download" link in file modals. Shows permission error.
          * @param {MouseEvent} e - The click event object.
          * @param {string} title - The title of the file being "downloaded".
          */
         const handleDownloadClick = (e, title) => {
              e.preventDefault(); // Prevent default link behavior
              console.log(`Download attempt blocked for: ${title}`);
              alert(PERMISSION_DENIED_MESSAGE); // Show the permission denied alert
         };

        /**
         * Generates the HTML content for the body of a standard modal based on its type.
         * @param {object} modalData - The data object for the current modal.
         * @returns {string} HTML string for the modal's content area.
         */
        const renderModalContent = (modalData) => {
            const { type, id, content, title } = modalData;

            // --- Folder View ---
            if (type === 'folder') {
                // List files within the folder as clickable buttons
                return `
                    <div class="p-3 space-y-1">
                        ${eventDocuments.map(doc => `
                            <button data-doc-id="${doc.id}" class="folder-file-item w-full text-left flex items-center gap-2 px-3 py-1.5 rounded-md text-red-300 hover:bg-red-700 hover:text-white transition duration-150 text-sm">
                                <span class="icon-placeholder text-red-400 flex-shrink-0">${doc.icon}</span>
                                <span>${doc.label}</span>
                            </button>
                        `).join('')}
                    </div>
                `;
            }

            // --- Note Taking Modal Content (handled separately) ---
             if (type === 'note') return '';

            // --- SoundCloud Player App ---
            if (type === 'app' && id === 'soundcloud_player') {
                 // Embed the SoundCloud iframe provided by the user
                 const soundcloudEmbedCode = `<iframe width="100%" height="450" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/playlists/2013820284&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true"></iframe><div class="soundcloud-attribution"><a href="https://soundcloud.com/skywarp-media" title="Skywarp Media" target="_blank">Skywarp Media</a> · <a href="https://soundcloud.com/skywarp-media/sets/808os" title="808os" target="_blank">808os</a></div>`;
                 // Wrap in a container div
                 return `
                    <div class="w-full h-full bg-black flex flex-col">
                         ${soundcloudEmbedCode}
                    </div>`;
            }

            // --- YouTube Player App (Locked) ---
             if (type === 'app' && id === 'youtube_player') {
                  // Display permission denied message
                  return `
                     <div class="text-center p-5">
                          <span class="text-5xl mx-auto mb-4 text-red-500 inline-block">🎬</span>
                          <p class="text-lg font-semibold mb-2 text-red-400">${title}</p>
                          <p class="text-sm text-yellow-500 mt-4 p-3 bg-gray-800 border border-yellow-700 rounded">${PERMISSION_DENIED_MESSAGE}</p>
                     </div>`;
             }

            // --- System Modals ---
            if (type === 'system') {
                const icon = title === 'Trash' ? '🗑️' : '📶';
                if (id === 'network') {
                    // Network modal with a locked button
                     return `
                         <div class="text-center p-5">
                             <span class="text-5xl mx-auto mb-4 text-gray-500 inline-block">${icon}</span>
                             <p class="text-lg font-semibold mb-2 text-red-400">${title}</p>
                             <p class="text-sm text-gray-400 mb-4">Network interface access is restricted.</p>
                             <button onclick="alert(PERMISSION_DENIED_MESSAGE)" class="mt-4 px-3 py-1 bg-purple-600 hover:bg-purple-500 text-white text-xs rounded-md disabled:bg-gray-700 disabled:cursor-not-allowed" disabled>
                                 Launch Interface (Locked)
                             </button>
                         </div>`;
                } else {
                    // Default error display for other system modals (like Trash if opened)
                     return `
                         <div class="text-center p-5">
                             <span class="text-5xl mx-auto mb-4 text-gray-500 inline-block">${icon}</span>
                             <p class="text-lg font-semibold mb-2 text-red-400">${title}</p>
                              <p class="text-sm text-yellow-500 mt-4 p-3 bg-gray-800 border border-yellow-700 rounded">${PERMISSION_DENIED_MESSAGE}</p>
                         </div>`;
                }
            }

            // --- File Content ---
            // Parse and display content for regular file modals
            return `<div class="p-4 prose prose-sm prose-invert max-w-none">${parseContent(content)}</div>`;
        };

        /**
         * Renders the main structure of a standard modal window.
         */
        const renderModal = () => {
            const modalArea = document.getElementById('modal-area');
            if (!modalArea) return;

            // Remove any previously existing standard modal
            const existingModal = modalArea.querySelector('#standard-modal-container');
            if (existingModal) {
                existingModal.remove();
            }

            // Don't render if the modal state is closed
            if (!currentModal.isOpen) return;

            const { title, content, type, id } = currentModal;

             // Determine header icon and color based on modal type
             let headerIcon = '📄'; // Default: file
             let headerIconColor = 'text-red-400';
             if (type === 'app') {
                 headerIcon = id === 'youtube_player' ? '🎬' : '▶️';
                 headerIconColor = id === 'youtube_player' ? 'text-red-400' : 'text-pink-400';
             } else if (type === 'system') {
                 headerIcon = title === 'Trash' ? '🗑️' : '📶';
                 headerIconColor = 'text-gray-400';
             } else if (type === 'folder') {
                 headerIcon = '📁';
                 headerIconColor = 'text-yellow-500';
             }

            // Create the modal overlay container
            const modalContainer = document.createElement('div');
            modalContainer.id = 'standard-modal-container';
            modalContainer.className = 'fixed inset-0 z-40 modal-overlay bg-black bg-opacity-60 pointer-events-none'; // Dimmed background

            // Create the modal window element itself
            const modalElement = document.createElement('div');
             // Calculate initial centered position
             const modalWidth = Math.min(window.innerWidth * 0.8, 672); // Max width approx 2xl
             // Estimate height, allow more for SoundCloud player
             const modalHeightEstimate = (type === 'app' && id === 'soundcloud_player') ? Math.min(window.innerHeight * 0.8, 550) : window.innerHeight * 0.7;
             const initialX = Math.max(0, (window.innerWidth - modalWidth) / 2);
             const initialY = Math.max(PADDING, (window.innerHeight - modalHeightEstimate) / 2);

            // Set max height class based on type
             const maxHClass = (type === 'app' && id === 'soundcloud_player') ? 'max-h-[90vh]' : 'max-h-[80vh]';

            // Apply classes for styling, layout, animation, and dragging
            modalElement.className = `modal-container absolute z-50 bg-black rounded-lg w-full max-w-2xl ${maxHClass} flex flex-col pointer-events-auto animate-themed-pulse-border overflow-hidden cursor-grab`;
            // Set initial position using transform
            modalElement.style.transform = `translate(${initialX}px, ${initialY}px)`;
            modalElement.style.left = '0px'; // Required for transform positioning
            modalElement.style.top = '0px';  // Required for transform positioning


            // Define the inner HTML of the modal (header, content area, footer)
            modalElement.innerHTML = `
                <div class="modal-header flex items-center justify-between p-3 border-b border-pink-700 bg-gradient-to-r from-purple-900 via-pink-900 to-red-900 cursor-grab select-none flex-shrink-0">
                    <h2 class="text-lg font-bold text-gray-200 flex items-center gap-2">
                        <span class="icon-placeholder ${headerIconColor}">${headerIcon}</span>
                        ${title}
                    </h2>
                    <button class="modal-close-button p-1 rounded-full text-gray-300 hover:bg-red-700 hover:text-white transition duration-150 focus:outline-none focus:ring-2 focus:ring-pink-500 cursor-pointer" aria-label="Close modal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="modal-content-area overflow-y-auto text-red-300 text-sm leading-relaxed select-none bg-black bg-opacity-80 flex-grow">
                    ${renderModalContent(currentModal)}
                </div>
                ${type === 'file' ? `
                <div class="modal-footer p-2 border-t border-purple-800/50 text-center bg-black bg-opacity-90 flex-shrink-0">
                    <a href="#" class="modal-download-link inline-flex items-center gap-1 text-xs text-cyan-400 hover:text-cyan-300 hover:underline">
                        <span class="icon-placeholder">⬇️</span> Download (Access Denied)
                    </a>
                </div>` : ''}
            `;

            // Append the modal window to the overlay, and the overlay to the modal area
            modalContainer.appendChild(modalElement);
            modalArea.appendChild(modalContainer);

             // --- Add Event Listeners for the new modal ---
             // Close button
             modalElement.querySelector('.modal-close-button').addEventListener('click', closeModal);

             // Download link (if present)
             const downloadLink = modalElement.querySelector('.modal-download-link');
             if (downloadLink) {
                 downloadLink.addEventListener('click', (e) => handleDownloadClick(e, title));
             }

              // File item buttons inside a folder modal
             if (type === 'folder') {
                 modalElement.querySelectorAll('.folder-file-item').forEach(button => {
                     button.addEventListener('click', () => {
                         const docId = button.getAttribute('data-doc-id');
                         const doc = eventDocuments.find(d => d.id === docId);
                         if (doc) {
                             openFileFromFolder(doc); // Open the clicked file
                         }
                     });
                 });
             }

             // Enable dragging by attaching mousedown listener to the modal element
             modalElement.addEventListener('mousedown', (e) => handleModalMouseDown(e, modalElement));
        };

        /**
         * Renders the dedicated 'New Note' modal window.
         */
        const renderNoteModal = () => {
            const modalArea = document.getElementById('modal-area');
            if (!modalArea) return;

            // Remove any existing note modal
            const existingModal = modalArea.querySelector('#note-modal-container');
            if (existingModal) {
                existingModal.remove();
            }

            // Don't render if the state is closed
            if (!isNoteModalOpen) return;

            // Create the overlay and modal elements
            const modalContainer = document.createElement('div');
            modalContainer.id = 'note-modal-container'; // Specific ID for note modal
            modalContainer.className = 'fixed inset-0 z-40 modal-overlay bg-black bg-opacity-60 pointer-events-none';

            const modalElement = document.createElement('div');
            // Calculate initial position
             const modalWidth = Math.min(window.innerWidth * 0.8, 672);
             const modalHeightEstimate = window.innerHeight * 0.7;
             const initialX = Math.max(0, (window.innerWidth - modalWidth) / 2);
             const initialY = Math.max(PADDING, (window.innerHeight - modalHeightEstimate) / 2);

            // Apply styling and positioning
            modalElement.className = `modal-container absolute z-50 bg-black rounded-lg w-full max-w-2xl max-h-[80vh] flex flex-col pointer-events-auto animate-themed-pulse-border overflow-hidden cursor-grab`;
            modalElement.style.transform = `translate(${initialX}px, ${initialY}px)`;
            modalElement.style.left = '0px';
            modalElement.style.top = '0px';

            // Define the inner HTML for the note modal (header, title input, content textarea, footer with send button)
            modalElement.innerHTML = `
                <div class="modal-header flex items-center justify-between p-3 border-b border-pink-700 bg-gradient-to-r from-purple-900 via-pink-900 to-red-900 cursor-grab select-none">
                    <h2 class="text-lg font-bold text-gray-200 flex items-center gap-2">
                        <span class="icon-placeholder text-yellow-400">📝</span> New Note
                    </h2>
                    <button class="modal-close-button p-1 rounded-full text-gray-300 hover:bg-red-700 hover:text-white transition duration-150 focus:outline-none focus:ring-2 focus:ring-pink-500 cursor-pointer" aria-label="Close modal">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="modal-content-area p-4 flex flex-col h-full overflow-y-auto bg-black bg-opacity-80 flex-grow">
                     <input type="text" id="note-title-input" placeholder="Note Title" value="New Note"
                            class="w-full px-3 py-2 mb-3 bg-gray-900 border border-purple-700 rounded-md text-pink-300 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-pink-500 flex-shrink-0">
                    <textarea id="note-content-input" placeholder="Enter your note here..."
                              class="w-full h-48 px-3 py-2 bg-gray-900 border border-purple-700 rounded-md text-gray-300 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-pink-500 resize-none flex-grow"></textarea>
                </div>
                <div class="modal-footer p-2 border-t border-purple-800/50 text-right bg-black bg-opacity-90 flex-shrink-0">
                    <button id="note-send-button" class="inline-flex items-center gap-1 px-3 py-1 bg-green-700 hover:bg-green-600 text-white text-xs rounded-md">
                        <span class="icon-placeholder">✉️</span> Save & Send Note
                    </button>
                </div>
            `;

            // Append elements to the DOM
            modalContainer.appendChild(modalElement);
            modalArea.appendChild(modalContainer);

             // --- Add Event Listeners for the note modal ---
             // Close button
             modalElement.querySelector('.modal-close-button').addEventListener('click', closeNoteModal);

             // Send button
             modalElement.querySelector('#note-send-button').addEventListener('click', () => {
                 const titleInput = document.getElementById('note-title-input');
                 const contentInput = document.getElementById('note-content-input');
                 // Attempt to "send" the note; close modal only on success
                 if (handleSendNote(titleInput.value, contentInput.value)) {
                     closeNoteModal();
                 }
             });
              // Enable dragging
             modalElement.addEventListener('mousedown', (e) => handleModalMouseDown(e, modalElement));
        };

        // --- Hidden Boot Log Logic ---

        /**
         * Toggles the visibility of the hidden verbose boot log.
         */
        const toggleHiddenLog = () => {
            showHiddenLog = !showHiddenLog; // Flip the state flag
            renderHiddenLog(); // Re-render the log area
        };

        /**
         * Renders the hidden boot log overlay if showHiddenLog is true.
         */
        const renderHiddenLog = () => {
            const logArea = document.getElementById('hidden-log-area');
            if (!logArea) return;
            logArea.innerHTML = ''; // Clear previous log overlay

            // Don't render if the state is false
            if (!showHiddenLog) return;

            // Create the overlay element
            const logOverlay = document.createElement('div');
            logOverlay.className = 'hidden-log-overlay fixed inset-0 z-55 flex items-center justify-center bg-black bg-opacity-85 p-4 font-mono';
            // Add listener to close the log when clicking the overlay background
            logOverlay.addEventListener('click', toggleHiddenLog);

            // Define the inner structure of the log window
            logOverlay.innerHTML = `
                <div class="bg-black border border-gray-700 rounded-lg shadow-lg w-full max-w-3xl max-h-[80vh] flex flex-col" onclick="event.stopPropagation()"> <div class="flex items-center justify-between p-3 border-b border-gray-600">
                        <h2 class="text-lg font-bold text-gray-400">Verbose Boot Log</h2>
                        <button class="hidden-log-close p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white transition duration-150">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <pre class="p-4 overflow-y-auto text-green-500 text-xs flex-grow whitespace-pre-wrap">${VERBOSE_BOOT_MESSAGES.join('\n')}</pre>
                </div>
            `;
            // Append the overlay to the dedicated log area
            logArea.appendChild(logOverlay);

            // Add listener to the close button inside the log window
            logOverlay.querySelector('.hidden-log-close').addEventListener('click', toggleHiddenLog);
        };

        // --- Shutdown and Restart Logic ---

        /**
         * Handles the restart action: resets credentials and returns to login screen.
         */
        const handleRestart = () => {
            console.log("Restarting session...");
            credentials = { email: null, agentId: null }; // Clear credentials
            appState = 'login'; // Set state back to login
            render(); // Re-render the UI
        };

        /**
         * Initiates the shutdown process by showing a confirmation modal.
         */
        const handleInitiateShutdown = () => {
            appState = 'shutdown-confirm'; // Set state
            // Render the confirmation modal with appropriate callbacks
            renderConfirmationModal(
                "Confirm Shutdown",
                "Are you sure you want to shut down the OS?",
                handleConfirmShutdown, // Function to call on confirm
                handleCancelShutdown   // Function to call on cancel
            );
        };

        /**
         * Handles the confirmation of the shutdown action.
         */
        const handleConfirmShutdown = () => {
            appState = 'shutting-down'; // Set state
            removeConfirmationModal(); // Remove the confirmation dialog
            renderShutdownSequence(); // Start displaying the shutdown messages
        };

        /**
         * Handles the cancellation of the shutdown action.
         */
        const handleCancelShutdown = () => {
            appState = 'desktop'; // Return to desktop state
            removeConfirmationModal(); // Remove the confirmation dialog
            // No need to re-render desktop unless something else changed
        };

        /**
         * Final step after shutdown sequence: redirects the browser.
         */
        const handleShutdownComplete = () => {
            console.log("Shutdown sequence complete. Redirecting...");
            // Redirect to the specified website
            window.location.href = 'https://808mafia.live';
        };

        /**
         * Renders the shutdown confirmation modal.
         * @param {string} title - The title for the confirmation modal.
         * @param {string} message - The confirmation message text.
         * @param {Function} onConfirm - Callback function for the Confirm button.
         * @param {Function} onCancel - Callback function for the Cancel button.
         */
        const renderConfirmationModal = (title, message, onConfirm, onCancel) => {
             // Ensure any previous confirmation modal is removed
             removeConfirmationModal();

             // Create the overlay element
             const confirmModalOverlay = document.createElement('div');
             confirmModalOverlay.id = 'confirmation-modal';
             confirmModalOverlay.className = 'confirmation-modal-overlay fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-75 p-4 font-mono';

             // Define the inner structure of the confirmation dialog
             confirmModalOverlay.innerHTML = `
                 <div class="bg-black border border-yellow-600 rounded-lg shadow-xl shadow-yellow-900/50 w-full max-w-sm p-6">
                     <h2 class="text-lg font-bold text-yellow-400 flex items-center gap-2 mb-4">
                         <span class="icon-placeholder">⚠️</span> ${title}
                     </h2>
                     <p class="text-sm text-gray-300 mb-6">${message}</p>
                     <div class="flex justify-end gap-3">
                         <button id="confirm-cancel-button" class="px-4 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-500 transition duration-150 text-sm">Cancel</button>
                         <button id="confirm-confirm-button" class="px-4 py-1.5 bg-red-700 text-white rounded-md hover:bg-red-600 transition duration-150 text-sm">Confirm</button>
                     </div>
                 </div>
             `;
             // Append directly to body to ensure it's on top of other UI
             document.body.appendChild(confirmModalOverlay);

             // Attach the provided callbacks to the buttons
             document.getElementById('confirm-cancel-button').onclick = onCancel;
             document.getElementById('confirm-confirm-button').onclick = onConfirm;
        };

        /**
         * Removes the confirmation modal from the DOM if it exists.
         */
        const removeConfirmationModal = () => {
            const modal = document.getElementById('confirmation-modal');
            if (modal) {
                modal.remove();
            }
        };

        /**
         * Renders the final shutdown sequence screen, displaying messages one by one.
         */
        const renderShutdownSequence = () => {
            appRoot.innerHTML = ''; // Clear the main application root

            // Create the shutdown overlay
            const shutdownOverlay = document.createElement('div');
            shutdownOverlay.className = 'shutdown-overlay fixed inset-0 flex items-center justify-center bg-black text-red-500 font-mono p-4 z-[100]';

            // Define the structure for displaying messages
            shutdownOverlay.innerHTML = `
                 <div class="z-10 w-full max-w-xl bg-black bg-opacity-80 p-4 rounded-lg border border-red-800">
                     <pre id="shutdown-messages" class="whitespace-pre-wrap text-xs md:text-sm"></pre>
                 </div>
            `;
            // Append directly to body
            document.body.appendChild(shutdownOverlay);

            const messagesPre = document.getElementById('shutdown-messages');
            let currentIndex = 0;
            let displayedMessages = [];

            // Function to display the next message in the sequence
            function displayNextMessage() {
                if (currentIndex < SHUTDOWN_MESSAGES.length) {
                    displayedMessages.push(SHUTDOWN_MESSAGES[currentIndex]);
                    // Update the <pre> tag content, adding a blinking cursor effect
                    messagesPre.innerHTML = displayedMessages.join('\n') + '\n<div class="animate-pulse inline-block">_</div>';
                    currentIndex++;
                    // Schedule the next message display
                    setTimeout(displayNextMessage, SHUTDOWN_DELAY);
                } else {
                    // All messages displayed, remove cursor
                    messagesPre.innerHTML = displayedMessages.join('\n');
                    // Wait a bit, then trigger the final shutdown action (redirect)
                    setTimeout(handleShutdownComplete, SHUTDOWN_DELAY * 2);
                }
            }
            // Start displaying messages
            displayNextMessage();
        };


        // --- Global Event Listener (Escape Key) ---
        document.addEventListener('keydown', (event) => {
            // Handle Escape key presses for closing modals/menus
            if (event.key === 'Escape') {
                 if (isNoteModalOpen) { // Close note modal first
                     closeNoteModal();
                 } else if (currentModal.isOpen) { // Then close standard modal
                     closeModal();
                 } else if (isStartMenuOpen) { // Then close start menu
                     closeStartMenu();
                 } else if (appState === 'desktop' || appState === 'booting' || appState === 'login') {
                     // Allow toggling the hidden boot log in these states
                     toggleHiddenLog();
                 }
            }
        });

        // --- Main Render Function ---
        /**
         * The main function responsible for rendering the UI based on the current appState.
         * It clears previous overlays/modals before rendering the new state.
         */
        const render = () => {
             // --- Cleanup ---
             // Ensure any persistent overlays/modals from previous states are removed
             removeConfirmationModal();
             const existingNoteModal = document.getElementById('note-modal-container');
             if (existingNoteModal) existingNoteModal.remove();
             const existingStandardModal = document.getElementById('standard-modal-container');
             if (existingStandardModal) existingStandardModal.remove();
             const existingHiddenLog = document.querySelector('.hidden-log-overlay');
             if (existingHiddenLog) existingHiddenLog.remove();
             // Remove shutdown overlay if navigating away from shutting-down state (e.g., restart)
             const existingShutdownOverlay = document.querySelector('.shutdown-overlay');
             if (existingShutdownOverlay && appState !== 'shutting-down') existingShutdownOverlay.remove();


            // --- State-based Rendering ---
            // Call the appropriate render function based on the current appState
            switch (appState) {
                case 'booting':
                    renderBootScreen();
                    break;
                case 'login':
                    renderLoginScreen();
                    break;
                case 'desktop':
                    renderDesktop();
                    break;
                case 'shutdown-confirm':
                    // Desktop should remain visible; confirmation modal is rendered on top
                    // Ensure desktop is rendered if somehow lost (e.g., direct state change)
                    if (!document.getElementById('desktop-container')) {
                         renderDesktop();
                    }
                    // Confirmation modal itself is rendered by handleInitiateShutdown
                    break;
                case 'shutting-down':
                    // Handled entirely by renderShutdownSequence, which takes over the screen
                    // No explicit call needed here as it's triggered by handleConfirmShutdown
                    break;
                default:
                    // Fallback for invalid state
                    appRoot.innerHTML = `<p class="z-10 fixed inset-0 flex items-center justify-center">Error: Invalid application state.</p>`;
            }
        };

        // --- Initial Load ---
        /**
         * Entry point when the window finishes loading.
         * Starts the Matrix background and the initial UI render.
         */
        window.onload = () => {
            startMatrix(); // Start the background effect
            render(); // Start the application rendering cycle based on initial state ('booting')
        };

    </script>

</body>
</html>
